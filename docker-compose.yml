# Instagram Marketing API - Docker Compose
# Group B: Personal Automation (Hetzner CPX31 - 8GB RAM)
# Resource Allocation: 1.5GB RAM for this service

version: '3.8'

services:
  instagram-marketing:
    image: instagram-marketing:latest
    container_name: instagram-marketing-api
    restart: always
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - TZ=Asia/Seoul
    env_file:
      - .env
    volumes:
      - ./logs:/app/logs
      - ./.env:/app/.env:ro
    networks:
      - group_b_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1536M
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis for caching and rate limiting (optional)
  redis:
    image: redis:7-alpine
    container_name: instagram-marketing-redis
    restart: always
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - group_b_network
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 192M
        reservations:
          cpus: '0.1'
          memory: 64M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  group_b_network:
    name: group_b_network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  redis_data:
    name: instagram_marketing_redis_data
